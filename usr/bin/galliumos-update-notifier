#!/bin/sh
#
# galliumos-update-notifier
#

[ "$(groups | grep -w sudo)" ] || exit 0
[ "$1" = '--delay' ] && sleep 20 

UPD_COUNT=0
SEC_COUNT=0

/usr/lib/galliumos-update/update_package_index
PKG_LIST="$(apt-get -qqs dist-upgrade | grep ^Inst)"
#PKG_LIST="$(echo -e "pkg1\npkg2\npkg3 security\npkg4 security\npkg5\n")"
  
IFS="
"

for pkg in $PKG_LIST; do
  UPD_COUNT=$(( UPD_COUNT + 1 ))
  [ "$(echo $pkg | grep -i security)" ] && SEC_COUNT=$(( SEC_COUNT + 1 ))
done
#echo "upd:$UPD_COUNT  sec:$SEC_COUNT"

[ "$UPD_COUNT" -eq 0 ] && exit 0

SUMMARY='Software Updates Available'
UPD_INFO="$UPD_COUNT package update"
SEC_INFO="$SEC_COUNT security update"

[ "$UPD_COUNT" -ne 1 ] && UPD_INFO="${UPD_INFO}s"
[ "$SEC_COUNT" -ne 1 ] && SEC_INFO="${SEC_INFO}s"

BODY=$UPD_INFO
ICON='software-update-available'
URGENCY='normal'

if [ "$SEC_COUNT" -gt 0 ]; then
  BODY="$BODY\n$SEC_INFO"
  ICON='software-update-urgent'
  URGENCY='critical'
fi

notify-send -t 10000 -u "$URGENCY" -i "$ICON" "$SUMMARY" "$BODY"

